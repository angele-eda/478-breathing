<!doctype html>
<html lang="en" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>4-7-8 Breathing Timer (Sleep & Calm) | Breath24</title>
  <meta name="description" content="Free 4-7-8 breathing timer: inhale 4 seconds, hold 7, exhale 8. A simple rhythm many people use for sleep and calming stress." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b0f17" />

  <link rel="canonical" href="https://breath24.com/breathing/4-7-8-breathing/" />

  <meta property="og:type" content="website" />
  <meta property="og:title" content="4-7-8 Breathing Timer (Sleep & Calm) | Breath24" />
  <meta property="og:description" content="Inhale 4 • hold 7 • exhale 8 — a classic breathing exercise for sleep and calm." />
  <meta property="og:url" content="https://breath24.com/breathing/4-7-8-breathing/" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4-7-8 Breathing Timer | Breath24" />
  <meta name="twitter:description" content="Inhale 4 • hold 7 • exhale 8 — simple timer for sleep and calm." />

  <style>
    :root{
      --bg:#0b0f17;
      --text:#eaf0ff;
      --muted:#a9b4d0;
      --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.05);
      --btn:#1f2d4a;
      --btn2:#223559;

      --accent1: rgba(126,231,194,.95);
      --accent2: rgba(255,210,122,.85);

      /* Phase accents (subtle) */
      --p1: rgba(126,231,194,.12); /* inhale */
      --p2: rgba(255,210,122,.10); /* hold */
      --p3: rgba(99,102,241,.10);  /* exhale */

      --shadow: 0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: var(--bg);
      overflow-x:hidden;
      transition: background .35s ease;
    }

    /* Subtle phase background layer */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:-1;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(126,231,194,.08), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(255,210,122,.08), transparent 60%);
      opacity: 1;
      transition: opacity .35s ease, filter .35s ease;
      filter: saturate(1) contrast(1);
    }
    body::after{
      content:"";
      position:fixed;
      inset:-20px;
      pointer-events:none;
      z-index:-1;
      background:
        radial-gradient(900px 520px at 30% 8%, var(--phaseA, rgba(126,231,194,.10)), transparent 60%),
        radial-gradient(900px 520px at 82% 16%, var(--phaseB, rgba(255,210,122,.08)), transparent 62%),
        radial-gradient(900px 520px at 55% 85%, var(--phaseC, rgba(99,102,241,.08)), transparent 65%);
      opacity: .85;
      transition: opacity .45s ease, transform .65s ease;
      transform: translate3d(0,0,0);
    }

    a{color:inherit;text-decoration:none}
    .wrap{max-width:900px;margin:0 auto;padding:18px 16px 44px}

    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:8px 0 14px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, rgba(126,231,194,.35), rgba(255,210,122,.25));
      border:1px solid var(--line);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    h1{margin:0;font-size:16px}
    .sub{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      padding:9px 12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-size:13px;color:var(--muted);
      display:inline-flex;align-items:center;gap:8px;
    }
    .pill:hover{color:var(--text)}
    .lang{
      padding:9px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      outline:none;
      cursor:pointer;
    }

    .panel{
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .title{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:12px;flex-wrap:wrap;
    }
    .title h2{margin:0;font-size:20px;letter-spacing:.1px}
    .title p{margin:6px 0 0;color:var(--muted);line-height:1.55}

    .layout{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:14px;
      align-items:stretch;
    }

    .stage{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(0,0,0,.16);
      padding:16px;
      position:relative;
      overflow:hidden;
      min-height: 360px;
    }

    /* --- Circle breathing visual --- */
    .circleWrap{
      display:grid;
      place-items:center;
      margin-top: 6px;
      padding: 8px 0 2px;
    }

    .ring{
      width: 260px;
      height: 260px;
      border-radius: 999px;
      position: relative;
      display:grid;
      place-items:center;
      background:
        radial-gradient(circle at 50% 45%, rgba(255,255,255,.07), transparent 55%),
        conic-gradient(var(--accent1) 0deg, rgba(255,255,255,.06) 0deg);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      transition: box-shadow .25s ease, transform .35s ease;
      transform: translateZ(0);
    }

    .bubble{
      width: 168px;
      height: 168px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.12), rgba(255,255,255,.04) 60%, rgba(0,0,0,.18));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 18px 55px rgba(0,0,0,.35);
      transform: scale(0.86);
      will-change: transform;
    }

    .ringGlow{
      box-shadow:
        0 0 0 1px rgba(255,255,255,.08) inset,
        0 18px 70px rgba(0,0,0,.45),
        0 0 42px rgba(126,231,194,.18);
    }

    .centerText{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      text-align:center;
      pointer-events:none;
    }
    .phase{
      font-size:13px;
      color:var(--muted);
      letter-spacing:.2px;
      margin-bottom: 4px;
    }
    .count{
      font-size:58px;
      line-height:1;
      font-weight:800;
      margin: 0;
    }
    .roundsInfo{
      font-size:12px;
      color:rgba(255,255,255,.55);
      margin-top: 8px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
      align-items:center;
    }
    .btn{
      padding:10px 12px;border-radius:12px;
      background:var(--btn);
      border:1px solid var(--line);
      color:var(--text);
      font-size:13px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background:var(--btn2)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .side{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.03);
      padding:14px;
    }

    .ctrl{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
    }
    .field{
      grid-column: span 12;
      background: var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .field2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:8px}
    input,select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }

    .more{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .linkbtn{
      padding:9px 12px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-size:13px;color:var(--muted);
    }
    .linkbtn:hover{color:var(--text)}

    .seoBlock{
      margin-top:14px;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.70);
      line-height:1.65;
    }
    .seoBlock h3{
      margin:0 0 8px;
      font-size:14px;
      color: rgba(255,255,255,.88);
      letter-spacing:-.01em;
    }
    .seoBlock p{margin:0;font-size:12.5px;color: rgba(255,255,255,.65)}

    footer{
      margin-top:16px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding-top:14px;
      border-top:1px solid var(--line)
    }

    @media (max-width: 920px){
      .layout{grid-template-columns:1fr}
      .stage{min-height: 340px}
    }
    @media (max-width: 520px){
      .ring{width: 240px; height: 240px}
      .bubble{width: 154px; height: 154px}
      .count{font-size:52px}
    }
  </style>

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"4-7-8 Breathing Timer",
    "url":"https://breath24.com/breathing/4-7-8-breathing/",
    "description":"Free 4-7-8 breathing timer: inhale 4 seconds, hold 7, exhale 8. Great for sleep and calming stress.",
    "isPartOf":{"@type":"WebSite","name":"Breath24","url":"https://breath24.com/"}
  }
  </script>

  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"HowTo",
    "name":"4-7-8 Breathing",
    "description":"Inhale 4 seconds, hold 7 seconds, exhale 8 seconds.",
    "step":[
      {"@type":"HowToStep","name":"Inhale","text":"Inhale through your nose for 4 seconds."},
      {"@type":"HowToStep","name":"Hold","text":"Hold your breath for 7 seconds."},
      {"@type":"HowToStep","name":"Exhale","text":"Exhale slowly for 8 seconds."}
    ]
  }
  </script>
</head>

<body>
  <div class="wrap">
    <header>
      <a class="brand" href="/">
        <span class="logo" aria-hidden="true"></span>
        <span>
          <h1>Breath24</h1>
          <div class="sub" id="t_subhead">4-7-8 breathing</div>
        </span>
      </a>

      <nav class="nav">
        <a class="pill" href="/breathing/" id="t_nav_library">Library</a>
        <a class="pill" href="/guide/" id="t_nav_guide">Guide</a>
        <a class="pill" href="/about.html" id="t_nav_about">About</a>

        <select class="lang" id="langSelect" aria-label="Language">
          <option value="en">EN</option>
          <option value="ko">KO</option>
          <option value="ja">JA</option>
          <option value="es">ES</option>
        </select>
      </nav>
    </header>

    <section class="panel">
      <div class="title">
        <div>
          <h2 id="t_title">4-7-8 Breathing Timer</h2>
          <p id="t_desc">Inhale 4 • Hold 7 • Exhale 8. A simple rhythm many people use for sleep and calming stress.</p>
        </div>
      </div>

      <div class="layout">
        <!-- Main stage -->
        <div class="stage">
          <div class="circleWrap">
            <div class="ring" id="ring" aria-hidden="true">
              <div class="bubble" id="bubble"></div>
              <div class="centerText">
                <div>
                  <div class="phase" id="phaseLabel">Ready</div>
                  <div class="count" id="count" aria-live="polite">—</div>
                  <div class="roundsInfo" id="roundInfo">Round 1/6</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <button class="btn" id="startBtn">Start</button>
            <button class="btn" id="pauseBtn" disabled>Pause</button>
            <button class="btn" id="resetBtn">Reset</button>
          </div>

          <div class="hint" id="statusHint">Tip: Keep shoulders relaxed. If you feel dizzy, stop and breathe normally.</div>

          <div class="more" aria-label="More breathing timers">
            <a class="linkbtn" href="/breathing/" id="t_back">← Back to Library</a>
            <a class="linkbtn" href="/breathing/box-breathing/" id="t_more_box">Box Breathing</a>
            <a class="linkbtn" href="/breathing/4-4-6-breathing/" id="t_more_446">4-4-6 Breathing</a>
          </div>

          <div class="seoBlock" aria-label="SEO">
            <h3 id="t_seoTitle">What is 4-7-8 breathing?</h3>
            <p id="t_seoText">
              4-7-8 breathing is a simple pattern: inhale for 4 seconds, hold for 7 seconds, and exhale for 8 seconds.
              Many people use it to relax before sleep or to calm stress.
            </p>
          </div>
        </div>

        <!-- Settings side -->
        <aside class="side">
          <div class="ctrl">
            <div class="field">
              <div class="field2">
                <div>
                  <label for="rounds" id="t_rounds">Rounds</label>
                  <input id="rounds" type="number" min="1" max="50" value="6" inputmode="numeric" />
                </div>
                <div>
                  <label for="sound" id="t_sound">Sound</label>
                  <select id="sound">
                    <option value="off" id="t_sound_off">Off</option>
                    <option value="soft" id="t_sound_soft" selected>Soft beep</option>
                  </select>
                </div>
              </div>
              <div class="hint" id="t_sound_note" style="margin-top:10px">
                Sound starts after you press Start (mobile browsers require a tap).
              </div>
            </div>

            <div class="field">
              <label id="t_tipLabel">Safety</label>
              <div class="hint" id="t_tipText">
                If you feel dizzy or uncomfortable, stop and breathe normally.
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <footer>
      <div>© <span id="y"></span> Breath24</div>
      <div>
        <a href="/privacy.html" id="t_privacy">Privacy</a> · <a href="/terms.html" id="t_terms">Terms</a>
      </div>
    </footer>
  </div>

<script>
(() => {
  // ---- I18N ----
  const I18N = {
    en: {
      subhead:"4-7-8 breathing",
      nav:{library:"Library", guide:"Guide", about:"About"},
      title:"4-7-8 Breathing Timer",
      desc:"Inhale 4 • Hold 7 • Exhale 8. A simple rhythm many people use for sleep and calming stress.",
      phase:{ready:"Ready", done:"Done", inhale:"Inhale", hold:"Hold", exhale:"Exhale"},
      buttons:{start:"Start", running:"Running...", pause:"Pause", resume:"Resume", reset:"Reset"},
      rounds:"Rounds",
      sound:"Sound",
      soundOff:"Off",
      soundSoft:"Soft beep",
      soundNote:"Sound starts after you press Start (mobile browsers require a tap).",
      hintReady:"Tip: Keep shoulders relaxed. If you feel dizzy, stop and breathe normally.",
      hintRun:"Follow the cue. If uncomfortable, pause or reset.",
      hintPaused:"Paused. Resume when ready.",
      hintBack:"Back to rhythm.",
      hintDone:"Nice. Return to normal breathing for a moment.",
      back:"← Back to Library",
      moreBox:"Box Breathing",
      more446:"4-4-6 Breathing",
      seoTitle:"What is 4-7-8 breathing?",
      seoText:"4-7-8 breathing is a simple pattern: inhale for 4 seconds, hold for 7 seconds, and exhale for 8 seconds. Many people use it to relax before sleep or to calm stress.",
      tipLabel:"Safety",
      tipText:"If you feel dizzy or uncomfortable, stop and breathe normally.",
      privacy:"Privacy",
      terms:"Terms",
      metaTitle:"4-7-8 Breathing Timer (Sleep & Calm) | Breath24",
      metaDesc:"Free 4-7-8 breathing timer: inhale 4 seconds, hold 7, exhale 8. A simple rhythm many people use for sleep and calming stress."
    },
    ko: {
      subhead:"4-7-8 호흡",
      nav:{library:"라이브러리", guide:"가이드", about:"소개"},
      title:"4-7-8 호흡 타이머",
      desc:"4초 들숨 • 7초 멈춤 • 8초 날숨. 수면과 긴장 완화에 자주 쓰는 간단한 리듬입니다.",
      phase:{ready:"준비", done:"완료", inhale:"들이마시기", hold:"멈춤", exhale:"내쉬기"},
      buttons:{start:"시작", running:"진행중...", pause:"일시정지", resume:"계속", reset:"리셋"},
      rounds:"라운드",
      sound:"사운드",
      soundOff:"끔",
      soundSoft:"부드러운 비프음",
      soundNote:"모바일 브라우저는 ‘시작’ 터치 후에만 소리가 납니다.",
      hintReady:"팁: 어깨 힘을 빼고 편하게 하세요. 어지러우면 중단하고 정상 호흡하세요.",
      hintRun:"표시를 따라가세요. 불편하면 일시정지 또는 리셋하세요.",
      hintPaused:"일시정지됨. 준비되면 다시 시작하세요.",
      hintBack:"리듬으로 복귀.",
      hintDone:"좋아요. 잠시 정상 호흡으로 돌아가세요.",
      back:"← 라이브러리로",
      moreBox:"박스 호흡",
      more446:"4-4-6 호흡",
      seoTitle:"4-7-8 호흡이란?",
      seoText:"4-7-8 호흡은 4초 들숨, 7초 멈춤, 8초 날숨으로 구성된 간단한 호흡 패턴입니다. 수면 전 이완이나 스트레스 완화에 자주 사용됩니다.",
      tipLabel:"주의",
      tipText:"어지럽거나 불편하면 중단하고 정상 호흡을 하세요.",
      privacy:"개인정보처리방침",
      terms:"이용약관",
      metaTitle:"4-7-8 호흡 타이머(수면/이완) | Breath24",
      metaDesc:"무료 4-7-8 호흡 타이머: 4초 들숨, 7초 멈춤, 8초 날숨. 수면과 스트레스 완화에 도움이 됩니다."
    },
    ja: {
      subhead:"4-7-8 呼吸",
      nav:{library:"ライブラリ", guide:"ガイド", about:"紹介"},
      title:"4-7-8 呼吸タイマー",
      desc:"4秒吸う • 7秒止める • 8秒吐く。睡眠やリラックスに使われるシンプルなリズムです。",
      phase:{ready:"準備", done:"完了", inhale:"吸う", hold:"止める", exhale:"吐く"},
      buttons:{start:"開始", running:"実行中...", pause:"一時停止", resume:"再開", reset:"リセット"},
      rounds:"ラウンド",
      sound:"サウンド",
      soundOff:"オフ",
      soundSoft:"ソフトビープ",
      soundNote:"モバイルでは「開始」タップ後に音が有効になります。",
      hintReady:"ヒント: 肩の力を抜いて。めまいがしたら中止して通常呼吸に戻してください。",
      hintRun:"合図に従ってください。無理なら一時停止/リセット。",
      hintPaused:"一時停止中。準備ができたら再開。",
      hintBack:"リズムに戻りました。",
      hintDone:"よくできました。少し通常呼吸に戻しましょう。",
      back:"← ライブラリへ",
      moreBox:"ボックス呼吸",
      more446:"4-4-6 呼吸",
      seoTitle:"4-7-8 呼吸とは？",
      seoText:"4-7-8 呼吸は、4秒吸って、7秒止めて、8秒吐くシンプルなパターンです。就寝前のリラックスやストレス軽減に使われます。",
      tipLabel:"注意",
      tipText:"めまいや不快感があれば中止し、通常呼吸をしてください。",
      privacy:"プライバシー",
      terms:"利用規約",
      metaTitle:"4-7-8 呼吸タイマー(睡眠/リラックス) | Breath24",
      metaDesc:"無料 4-7-8 呼吸タイマー: 4秒吸う、7秒止める、8秒吐く。睡眠と落ち着きに。"
    },
    es: {
      subhead:"Respiración 4-7-8",
      nav:{library:"Biblioteca", guide:"Guía", about:"Acerca de"},
      title:"Temporizador de respiración 4-7-8",
      desc:"Inhala 4 • Mantén 7 • Exhala 8. Un ritmo simple para dormir y calmar el estrés.",
      phase:{ready:"Listo", done:"Hecho", inhale:"Inhala", hold:"Mantén", exhale:"Exhala"},
      buttons:{start:"Empezar", running:"En curso...", pause:"Pausar", resume:"Reanudar", reset:"Reiniciar"},
      rounds:"Rondas",
      sound:"Sonido",
      soundOff:"Apagado",
      soundSoft:"Pitido suave",
      soundNote:"El sonido se activa tras pulsar Empezar (móvil requiere toque).",
      hintReady:"Consejo: Relaja los hombros. Si te mareas, detente y respira normal.",
      hintRun:"Sigue la guía. Si incomoda, pausa o reinicia.",
      hintPaused:"Pausado. Reanuda cuando estés listo.",
      hintBack:"De vuelta al ritmo.",
      hintDone:"Bien. Vuelve a respiración normal un momento.",
      back:"← Volver a la biblioteca",
      moreBox:"Respiración en caja",
      more446:"Respiración 4-4-6",
      seoTitle:"¿Qué es la respiración 4-7-8?",
      seoText:"La respiración 4-7-8 es un patrón simple: inhala 4 segundos, mantén 7 y exhala 8. Se usa para relajarse antes de dormir o calmar el estrés.",
      tipLabel:"Seguridad",
      tipText:"Si te mareas o te sientes mal, detente y respira normalmente.",
      privacy:"Privacidad",
      terms:"Términos",
      metaTitle:"Temporizador 4-7-8 (Sueño y calma) | Breath24",
      metaDesc:"Temporizador gratis 4-7-8: inhala 4, mantén 7, exhala 8. Útil para dormir y calmar el estrés."
    }
  };

  function detectLang(){
    const qs = new URLSearchParams(location.search);
    const q = (qs.get("lang")||"").toLowerCase();
    if (I18N[q]) return q;
    const saved = (localStorage.getItem("b24_lang")||"").toLowerCase();
    if (I18N[saved]) return saved;
    const nav = (navigator.language || "en").toLowerCase();
    if (nav.startsWith("ko")) return "ko";
    if (nav.startsWith("ja")) return "ja";
    if (nav.startsWith("es")) return "es";
    return "en";
  }

  function setMeta(title, desc){
    document.title = title;
    const md = document.querySelector('meta[name="description"]');
    if (md) md.setAttribute("content", desc);

    const ogt = document.querySelector('meta[property="og:title"]');
    const ogd = document.querySelector('meta[property="og:description"]');
    if (ogt) ogt.setAttribute("content", title);
    if (ogd) ogd.setAttribute("content", desc);

    const twt = document.querySelector('meta[name="twitter:title"]');
    const twd = document.querySelector('meta[name="twitter:description"]');
    if (twt) twt.setAttribute("content", title);
    if (twd) twd.setAttribute("content", desc);
  }

  // ---- Breathing logic ----
  const pattern = [
    { key:"inhale", seconds:4 },
    { key:"hold",   seconds:7 },
    { key:"exhale", seconds:8 }
  ];

  const ring = document.getElementById('ring');
  const bubble = document.getElementById('bubble');
  const phaseLabel = document.getElementById('phaseLabel');
  const countEl = document.getElementById('count');
  const roundInfo = document.getElementById('roundInfo');
  const roundsInput = document.getElementById('rounds');
  const soundSel = document.getElementById('sound');
  const statusHint = document.getElementById('statusHint');

  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resetBtn = document.getElementById('resetBtn');

  let timer = null;
  let running = false;
  let paused = false;

  let round = 1;
  let phaseIdx = 0;
  let remaining = pattern[0].seconds;
  let phaseTotal = pattern[0].seconds;

  // audio
  let audioCtx = null;

  // haptics user option (implicit on, respects device)
  let hapticsOn = true;

  function ensureAudio(){
    if (soundSel.value === "off") return;
    if (!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === "suspended"){
      audioCtx.resume().catch(()=>{});
    }
  }

  function beep(){
    if (soundSel.value === "off") return;
    try{
      ensureAudio();
      if (!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.value = 880;

      const now = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.05, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.10);

      o.connect(g);
      g.connect(audioCtx.destination);

      o.start(now);
      o.stop(now + 0.12);
    }catch(e){}
  }

  // ✅ Haptics: subtle patterns
  function vibrate(msOrPattern){
    if (!hapticsOn) return;
    try{
      if (!("vibrate" in navigator)) return;
      navigator.vibrate(msOrPattern);
    }catch(e){}
  }

  function maxRounds(){
    return Math.max(1, parseInt(roundsInput.value || '1', 10));
  }
  function phaseKey(){
    return pattern[phaseIdx].key;
  }

  function totalCycleSeconds(){
    return pattern.reduce((s,p)=>s+p.seconds,0);
  }
  function elapsedInCycle(){
    let e = 0;
    for (let i=0;i<phaseIdx;i++) e += pattern[i].seconds;
    e += (phaseTotal - remaining);
    return Math.max(0, e);
  }

  function setRingProgress(){
    const cycle = totalCycleSeconds();
    const deg = cycle ? (elapsedInCycle() / cycle) * 360 : 0;
    ring.style.background =
      `radial-gradient(circle at 50% 45%, rgba(255,255,255,.07), transparent 55%),
       conic-gradient(var(--accent1) ${deg}deg, rgba(255,255,255,.06) 0deg)`;
  }

  function animateBubbleForPhase(pKey, seconds){
    bubble.getAnimations().forEach(a => a.cancel());

    const base = 0.86;
    const big  = 1.10;
    const small= 0.78;

    let kf;
    if (pKey === "inhale"){
      ring.classList.add("ringGlow");
      kf = [{ transform: `scale(${base})` }, { transform: `scale(${big})` }];
    }else if (pKey === "hold"){
      ring.classList.add("ringGlow");
      kf = [{ transform: `scale(${big})` }, { transform: `scale(${big})` }];
    }else{
      ring.classList.remove("ringGlow");
      kf = [{ transform: `scale(${big})` }, { transform: `scale(${small})` }];
    }

    bubble.animate(kf, {
      duration: Math.max(220, seconds*1000),
      easing: "cubic-bezier(.2,.9,.2,1)",
      fill: "forwards"
    });
  }

  // ✅ Background phase gradient shift (subtle)
  function applyPhaseBackground(pKey){
    // choose weights
    const root = getComputedStyle(document.documentElement);
    const p1 = root.getPropertyValue("--p1").trim() || "rgba(126,231,194,.12)";
    const p2 = root.getPropertyValue("--p2").trim() || "rgba(255,210,122,.10)";
    const p3 = root.getPropertyValue("--p3").trim() || "rgba(99,102,241,.10)";

    let A=p1, B=p2, C=p3;
    let move = "translate3d(0,0,0)";
    let opacity = 0.85;

    if (pKey === "inhale"){
      A = p1; B = "rgba(255,210,122,.06)"; C = "rgba(99,102,241,.06)";
      move = "translate3d(0,-6px,0)";
      opacity = 0.92;
    } else if (pKey === "hold"){
      A = "rgba(126,231,194,.07)"; B = p2; C = "rgba(99,102,241,.06)";
      move = "translate3d(0,-2px,0)";
      opacity = 0.88;
    } else { // exhale
      A = "rgba(126,231,194,.06)"; B = "rgba(255,210,122,.06)"; C = p3;
      move = "translate3d(0,6px,0)";
      opacity = 0.90;
    }

    document.body.style.setProperty("--phaseA", A);
    document.body.style.setProperty("--phaseB", B);
    document.body.style.setProperty("--phaseC", C);
    // move via CSS variable-ish (use style on ::after by toggling body class? easiest: set on body dataset and adjust with inline style)
    document.body.style.setProperty("--phaseMove", move);

    // We can't directly set ::after transform via CSS var unless used, so we use a tiny trick:
    document.body.dataset.phase = pKey;

    // adjust opacity by setting a CSS custom property, used by a style injection
    document.body.style.setProperty("--phaseOpacity", String(opacity));
  }

  // inject a tiny dynamic css that reads dataset + vars (no external files)
  const styleDyn = document.createElement("style");
  styleDyn.textContent = `
    body::after{ opacity: var(--phaseOpacity, .85); }
    body[data-phase="inhale"]::after{ transform: translate3d(0,-6px,0); }
    body[data-phase="hold"]::after{ transform: translate3d(0,-2px,0); }
    body[data-phase="exhale"]::after{ transform: translate3d(0,6px,0); }
    body[data-phase="ready"]::after{ transform: translate3d(0,0,0); opacity: .85; }
  `;
  document.head.appendChild(styleDyn);

  function render(){
    const lang = document.documentElement.lang || "en";
    const t = I18N[lang] || I18N.en;

    if (!running){
      phaseLabel.textContent = t.phase.ready;
      countEl.textContent = "—";
      roundInfo.textContent = `Round 1/${maxRounds()}`;
      ring.classList.remove("ringGlow");
      ring.style.background =
        `radial-gradient(circle at 50% 45%, rgba(255,255,255,.07), transparent 55%),
         conic-gradient(var(--accent1) 0deg, rgba(255,255,255,.06) 0deg)`;
      bubble.getAnimations().forEach(a=>a.cancel());
      bubble.style.transform = "scale(0.86)";
      statusHint.textContent = t.hintReady;

      applyPhaseBackground("ready");
      return;
    }

    const pKey = phaseKey();
    phaseLabel.textContent = t.phase[pKey];
    countEl.textContent = String(Math.max(0, remaining));
    roundInfo.textContent = `Round ${round}/${maxRounds()}`;
    setRingProgress();
    applyPhaseBackground(pKey);
  }

  function tick(){
    if (!running || paused) return;

    render();

    if (remaining <= 0){
      // phase change
      beep();

      // ✅ haptics per phase transition (soft)
      // short pulse on each phase change; slightly different pattern by next phase
      const nextIdx = (phaseIdx + 1) % pattern.length;
      const nextKey = pattern[nextIdx].key;
      if (nextKey === "inhale") vibrate([18, 24, 18]);      // cue inhale
      else if (nextKey === "hold") vibrate(18);             // cue hold
      else vibrate([12, 18, 12]);                           // cue exhale

      phaseIdx++;
      if (phaseIdx >= pattern.length){
        phaseIdx = 0;
        round++;
      }

      if (round > maxRounds()){
        stop(true);
        return;
      }

      remaining = pattern[phaseIdx].seconds;
      phaseTotal = remaining;

      animateBubbleForPhase(phaseKey(), phaseTotal);
      render();
      return;
    }

    remaining -= 1;
  }

  function setLang(lang){
    if(!I18N[lang]) lang = "en";
    localStorage.setItem("b24_lang", lang);
    document.documentElement.lang = lang;

    const t = I18N[lang];
    document.getElementById("t_subhead").textContent = t.subhead;
    document.getElementById("t_nav_library").textContent = t.nav.library;
    document.getElementById("t_nav_guide").textContent = t.nav.guide;
    document.getElementById("t_nav_about").textContent = t.nav.about;

    document.getElementById("t_title").textContent = t.title;
    document.getElementById("t_desc").textContent = t.desc;

    document.getElementById("t_rounds").textContent = t.rounds;
    document.getElementById("t_sound").textContent = t.sound;
    document.getElementById("t_sound_off").textContent = t.soundOff;
    document.getElementById("t_sound_soft").textContent = t.soundSoft;
    document.getElementById("t_sound_note").textContent = t.soundNote;

    document.getElementById("t_back").textContent = t.back;
    document.getElementById("t_more_box").textContent = t.moreBox;
    document.getElementById("t_more_446").textContent = t.more446;

    document.getElementById("t_seoTitle").textContent = t.seoTitle;
    document.getElementById("t_seoText").textContent = t.seoText;

    document.getElementById("t_tipLabel").textContent = t.tipLabel;
    document.getElementById("t_tipText").textContent = t.tipText;

    document.getElementById("t_privacy").textContent = t.privacy;
    document.getElementById("t_terms").textContent = t.terms;

    // buttons
    startBtn.textContent = t.buttons.start;
    pauseBtn.textContent = t.buttons.pause;
    resetBtn.textContent = t.buttons.reset;

    // meta
    setMeta(t.metaTitle, t.metaDesc);

    render();
  }

  function start(){
    const lang = document.documentElement.lang || "en";
    const t = I18N[lang] || I18N.en;

    // mobile: enable audio on tap
    ensureAudio();

    if (running && !paused) return;

    if (!running){
      round = 1;
      phaseIdx = 0;
      remaining = pattern[0].seconds;
      phaseTotal = remaining;
      animateBubbleForPhase(phaseKey(), phaseTotal);
      applyPhaseBackground(phaseKey());
      // ✅ tiny haptic on start
      vibrate(15);
    }

    running = true;
    paused = false;

    startBtn.textContent = t.buttons.running;
    startBtn.disabled = true;
    pauseBtn.disabled = false;

    statusHint.textContent = t.hintRun;

    if (timer) clearInterval(timer);
    timer = setInterval(tick, 1000);

    tick();
  }

  function pause(){
    if (!running) return;
    const lang = document.documentElement.lang || "en";
    const t = I18N[lang] || I18N.en;

    paused = !paused;
    pauseBtn.textContent = paused ? t.buttons.resume : t.buttons.pause;

    startBtn.disabled = !paused;
    startBtn.textContent = paused ? t.buttons.start : t.buttons.running;

    statusHint.textContent = paused ? t.hintPaused : t.hintBack;

    // ✅ haptic on pause/resume
    vibrate(paused ? 10 : 12);
  }

  function stop(completed=false){
    const lang = document.documentElement.lang || "en";
    const t = I18N[lang] || I18N.en;

    running = false;
    paused = false;

    if (timer) clearInterval(timer);
    timer = null;

    startBtn.disabled = false;
    startBtn.textContent = t.buttons.start;
    pauseBtn.disabled = true;
    pauseBtn.textContent = t.buttons.pause;

    phaseLabel.textContent = completed ? t.phase.done : t.phase.ready;
    countEl.textContent = "—";
    statusHint.textContent = completed ? t.hintDone : t.hintReady;

    ring.classList.remove("ringGlow");
    bubble.getAnimations().forEach(a=>a.cancel());
    bubble.style.transform = "scale(0.86)";

    applyPhaseBackground("ready");

    // ✅ done haptic
    if (completed) vibrate([18, 30, 18]);
    render();
  }

  function reset(){
    vibrate(10);
    stop(false);
  }

  // events
  startBtn.addEventListener('click', start);
  pauseBtn.addEventListener('click', pause);
  resetBtn.addEventListener('click', reset);
  roundsInput.addEventListener('change', () => render());

  // language
  const langSelect = document.getElementById("langSelect");
  const initial = detectLang();
  langSelect.value = initial;
  langSelect.addEventListener("change", (e) => setLang(e.target.value));

  // init
  document.getElementById('y').textContent = new Date().getFullYear();
  setLang(initial);
  applyPhaseBackground("ready");
})();
</script>
</body>
</html>