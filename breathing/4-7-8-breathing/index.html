<!doctype html>
<html lang="en" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>4-7-8 Breathing Timer (Sleep & Calm) | Breath24</title>
  <meta name="description" content="Free 4-7-8 breathing timer: inhale 4 seconds, hold 7, exhale 8. Simple rhythm for sleep and calming stress." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b0f17" />

  <link rel="canonical" href="https://breath24.com/breathing/4-7-8-breathing/" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="4-7-8 Breathing Timer (Sleep & Calm) | Breath24" />
  <meta property="og:description" content="Inhale 4 • hold 7 • exhale 8 — a classic breathing exercise for sleep and calm." />
  <meta property="og:url" content="https://breath24.com/breathing/4-7-8-breathing/" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4-7-8 Breathing Timer | Breath24" />
  <meta name="twitter:description" content="Inhale 4 • hold 7 • exhale 8 — simple timer for sleep and calm." />

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"4-7-8 Breathing Timer",
    "url":"https://breath24.com/breathing/4-7-8-breathing/",
    "description":"Free 4-7-8 breathing timer: inhale 4 seconds, hold 7, exhale 8. Great for sleep and calming stress.",
    "isPartOf":{"@type":"WebSite","name":"Breath24","url":"https://breath24.com/"}
  }
  </script>
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"HowTo",
    "name":"4-7-8 Breathing",
    "description":"Inhale 4 seconds, hold 7 seconds, exhale 8 seconds.",
    "step":[
      {"@type":"HowToStep","name":"Inhale","text":"Inhale through your nose for 4 seconds."},
      {"@type":"HowToStep","name":"Hold","text":"Hold your breath for 7 seconds."},
      {"@type":"HowToStep","name":"Exhale","text":"Exhale slowly for 8 seconds."}
    ]
  }
  </script>

  <style>
    :root{
      --bg:#0b0f17;
      --bg2:#091024;
      --text:rgba(234,240,255,.96);
      --muted:rgba(169,180,208,.88);
      --muted2:rgba(169,180,208,.70);
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);

      --card:rgba(255,255,255,.045);
      --card2:rgba(255,255,255,.03);

      --btn:#1f2d4a;
      --btn2:#223559;

      --inhale:#7ee7c2;
      --hold:#ffd27a;
      --exhale:#9db9ff;

      --shadow: 0 22px 60px rgba(0,0,0,.45);
      --r: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 18% 0%, rgba(126,231,194,.12), transparent 55%),
        radial-gradient(900px 520px at 85% 5%, rgba(255,210,122,.10), transparent 55%),
        radial-gradient(900px 520px at 70% 90%, rgba(157,185,255,.10), transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }

    a{color:inherit;text-decoration:none}
    .wrap{max-width:900px;margin:0 auto;padding:18px 16px 44px}

    header{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px; padding:8px 0 14px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, rgba(126,231,194,.35), rgba(255,210,122,.25));
      border:1px solid var(--line);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      flex:0 0 auto;
    }
    .brand h1{margin:0;font-size:16px;letter-spacing:.2px}
    .sub{margin:2px 0 0;font-size:12px;color:var(--muted2)}
    .nav{display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      padding:9px 12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-size:13px;color:var(--muted2);
    }
    .pill:hover{border-color:rgba(255,255,255,.18); color:var(--text)}

    .panel{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.028));
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(650px 220px at 15% 0%, rgba(126,231,194,.10), transparent 60%),
        radial-gradient(650px 220px at 85% 0%, rgba(255,210,122,.09), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }
    .panel > *{position:relative}

    .topRow{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .title h2{margin:0;font-size:22px;letter-spacing:-.2px}
    .title p{margin:6px 0 0;color:var(--muted);line-height:1.5}

    /* Controls (practical, slightly visible) */
    .controls{
      display:flex; gap:10px; align-items:stretch; flex-wrap:wrap;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:10px;
      min-width: 290px;
    }
    .ctrl{
      display:flex;flex-direction:column;gap:6px; min-width: 110px; flex:1 1 0;
    }
    .ctrl label{
      font-size:11px;color:var(--muted2);
      letter-spacing:.2px;
    }
    input,select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    select{cursor:pointer}

    .timer{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .big{
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      background: rgba(0,0,0,.18);
      padding:16px;
    }

    .phase{
      font-size:13px;color:var(--muted);
      letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.80);
      font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background:var(--muted2);
      box-shadow: 0 0 0 4px rgba(255,255,255,.04);
    }

    .count{
      font-size:56px;
      line-height:1;
      margin:10px 0 8px;
      font-weight:800;
      letter-spacing:-.02em;
    }

    .barWrap{
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(126,231,194,.90), rgba(255,210,122,.80));
      transition: width .25s linear, filter .25s linear;
      filter: saturate(1.15);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      padding:10px 12px;border-radius:12px;background:var(--btn);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);font-size:13px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background:var(--btn2); border-color: rgba(255,255,255,.14)}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .hint{margin-top:10px;color:var(--muted2);font-size:12px;line-height:1.55}

    .more{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .linkbtn{
      padding:9px 12px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:13px;color:var(--muted2)
    }
    .linkbtn:hover{color:var(--text); border-color: rgba(255,255,255,.16)}

    /* SEO content block */
    .seo{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      background: rgba(255,255,255,.03);
      padding:14px 14px 12px;
    }
    .seo h3{margin:0 0 8px; font-size:15px; color:rgba(255,255,255,.90)}
    .seo p{margin:0 0 10px; color:var(--muted2); font-size:13px; line-height:1.6}
    .seo ul{margin:0; padding-left:18px; color:var(--muted2); font-size:13px; line-height:1.6}

    footer{
      margin-top:16px;
      color:var(--muted2);
      font-size:12px;
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
      padding-top:14px;border-top:1px solid rgba(255,255,255,.10)
    }

    @media (max-width:720px){
      .count{font-size:50px}
      .controls{min-width: 0; width:100%}
      .ctrl{min-width: 0}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <a class="brand" href="/">
        <span class="logo" aria-hidden="true"></span>
        <span>
          <h1>Breath24</h1>
          <div class="sub" id="t_sub">4-7-8 breathing</div>
        </span>
      </a>
      <nav class="nav">
        <a class="pill" href="/breathing/" id="t_nav_lib">Library</a>
        <a class="pill" href="/guide/" id="t_nav_guide">Guide</a>
        <a class="pill" href="/about.html" id="t_nav_about">About</a>
      </nav>
    </header>

    <section class="panel">
      <div class="topRow">
        <div class="title">
          <h2 id="t_title">4-7-8 Breathing Timer</h2>
          <p id="t_desc">Inhale 4 • Hold 7 • Exhale 8. A simple rhythm many people use for sleep and calming stress.</p>
        </div>

        <!-- practical controls visible -->
        <div class="controls" aria-label="controls">
          <div class="ctrl">
            <label for="lang" id="t_langLabel">Language</label>
            <select id="lang">
              <option value="en">English</option>
              <option value="ko">한국어</option>
              <option value="ja">日本語</option>
              <option value="es">Español</option>
            </select>
          </div>

          <div class="ctrl">
            <label for="rounds" id="t_roundsLabel">Rounds</label>
            <input id="rounds" type="number" min="1" max="50" value="6" inputmode="numeric" />
          </div>

          <div class="ctrl">
            <label for="sound" id="t_soundLabel">Sound</label>
            <select id="sound">
              <option value="off" id="t_soundOff">Off</option>
              <option value="soft" selected id="t_soundSoft">Soft beep</option>
              <option value="strong" id="t_soundStrong">Stronger beep</option>
            </select>
          </div>
        </div>
      </div>

      <div class="timer">
        <div class="big">
          <div class="phase">
            <span id="phaseLabel">Ready</span>
            <span class="badge"><span class="dot" id="phaseDot"></span><span id="t_badge">Phase</span></span>
          </div>

          <div class="count" id="count" aria-live="polite">—</div>

          <div class="barWrap" aria-hidden="true"><div class="bar" id="bar"></div></div>

          <div class="row">
            <button class="btn" id="startBtn">Start</button>
            <button class="btn" id="pauseBtn" disabled>Pause</button>
            <button class="btn" id="resetBtn">Reset</button>
          </div>

          <div class="hint" id="statusHint">Tip: Keep shoulders relaxed. If you feel dizzy, stop and breathe normally.</div>

          <div class="more" aria-label="More breathing timers">
            <a class="linkbtn" href="/breathing/" id="t_back">← Back to Library</a>
            <a class="linkbtn" href="/breathing/box-breathing/" id="t_more1">Box Breathing</a>
            <a class="linkbtn" href="/breathing/4-4-6-breathing/" id="t_more2">4-4-6 Breathing</a>
          </div>
        </div>

        <!-- SEO content -->
        <div class="seo" aria-label="seo">
          <h3 id="t_seoTitle">What is 4-7-8 breathing?</h3>
          <p id="t_seoP1">
            4-7-8 is a simple paced breathing pattern: inhale for 4 seconds, hold for 7 seconds, and exhale for 8 seconds.
            Many people use it to relax before sleep or to calm down during stress.
          </p>
          <ul id="t_seoList">
            <li><b>Sleep:</b> try 4–8 rounds at night.</li>
            <li><b>Stress reset:</b> 2–4 rounds anytime.</li>
            <li><b>Safety:</b> if dizzy, stop and breathe normally.</li>
          </ul>
        </div>
      </div>
    </section>

    <footer>
      <div>© <span id="y"></span> Breath24</div>
      <div>
        <a href="/privacy.html">Privacy</a> · <a href="/terms.html">Terms</a>
      </div>
    </footer>
  </div>

<script>
(() => {
  // ====== Pattern ======
  const pattern = [
    { key:"inhale", seconds:4 },
    { key:"hold",   seconds:7 },
    { key:"exhale", seconds:8 }
  ];

  // ====== i18n ======
  const I18N = {
    en: {
      sub: "4-7-8 breathing",
      nav_lib: "Library",
      nav_guide: "Guide",
      nav_about: "About",
      title: "4-7-8 Breathing Timer",
      desc: "Inhale 4 • Hold 7 • Exhale 8. A simple rhythm many people use for sleep and calming stress.",
      badge: "Phase",
      langLabel: "Language",
      roundsLabel: "Rounds",
      soundLabel: "Sound",
      soundOff: "Off",
      soundSoft: "Soft beep",
      soundStrong: "Stronger beep",
      ready: "Ready",
      done: "Done",
      inhale: "Inhale",
      hold: "Hold",
      exhale: "Exhale",
      round: "Round",
      start: "Start",
      running: "Running...",
      pause: "Pause",
      resume: "Resume",
      reset: "Reset",
      tip_ready: "Tip: Keep shoulders relaxed. If you feel dizzy, stop and breathe normally.",
      tip_running: "Follow the cue. If uncomfortable, pause or reset.",
      tip_paused: "Paused. Resume when ready.",
      tip_back: "Back to rhythm.",
      tip_done: "Nice. Return to normal breathing for a moment.",
      back: "← Back to Library",
      more1: "Box Breathing",
      more2: "4-4-6 Breathing",
      seoTitle: "What is 4-7-8 breathing?",
      seoP1: "4-7-8 is a simple paced breathing pattern: inhale for 4 seconds, hold for 7 seconds, and exhale for 8 seconds. Many people use it to relax before sleep or to calm down during stress.",
      seoList: [
        "<b>Sleep:</b> try 4–8 rounds at night.",
        "<b>Stress reset:</b> 2–4 rounds anytime.",
        "<b>Safety:</b> if dizzy, stop and breathe normally."
      ],
      // for screen label
      phaseLine: (phase, round, max) => `${phase}  •  ${I18N.en.round} ${round}/${max}`
    },
    ko: {
      sub: "4-7-8 호흡",
      nav_lib: "라이브러리",
      nav_guide: "가이드",
      nav_about: "소개",
      title: "4-7-8 호흡 타이머",
      desc: "들이마시기 4 • 멈춤 7 • 내쉬기 8. 수면과 긴장 완화에 자주 쓰는 리듬입니다.",
      badge: "단계",
      langLabel: "언어",
      roundsLabel: "반복",
      soundLabel: "소리",
      soundOff: "끔",
      soundSoft: "부드러운 비프",
      soundStrong: "조금 큰 비프",
      ready: "준비",
      done: "완료",
      inhale: "들이마시기",
      hold: "멈춤",
      exhale: "내쉬기",
      round: "라운드",
      start: "시작",
      running: "진행중...",
      pause: "일시정지",
      resume: "재개",
      reset: "리셋",
      tip_ready: "팁: 어깨 힘을 빼고 편하게. 어지러우면 중단하고 자연호흡하세요.",
      tip_running: "표시된 리듬을 따라가세요. 불편하면 일시정지/리셋하세요.",
      tip_paused: "일시정지됨. 준비되면 재개하세요.",
      tip_back: "리듬으로 복귀.",
      tip_done: "좋아요. 잠시 자연호흡으로 돌아오세요.",
      back: "← 라이브러리로",
      more1: "박스 호흡",
      more2: "4-4-6 호흡",
      seoTitle: "4-7-8 호흡이란?",
      seoP1: "4-7-8은 들이마시기 4초, 멈춤 7초, 내쉬기 8초로 구성된 간단한 호흡 패턴입니다. 잠들기 전 이완이나 스트레스 완화에 많이 사용됩니다.",
      seoList: [
        "<b>수면:</b> 밤에 4~8라운드 추천",
        "<b>긴장 완화:</b> 언제든 2~4라운드",
        "<b>주의:</b> 어지러우면 중단 후 자연호흡"
      ],
      phaseLine: (phase, round, max) => `${phase}  •  ${I18N.ko.round} ${round}/${max}`
    },
    ja: {
      sub: "4-7-8 呼吸",
      nav_lib: "ライブラリ",
      nav_guide: "ガイド",
      nav_about: "紹介",
      title: "4-7-8 呼吸タイマー",
      desc: "吸う4 • 止める7 • 吐く8。睡眠やリラックスに使われるシンプルなリズムです。",
      badge: "フェーズ",
      langLabel: "言語",
      roundsLabel: "回数",
      soundLabel: "サウンド",
      soundOff: "オフ",
      soundSoft: "やさしいビープ",
      soundStrong: "強めのビープ",
      ready: "準備",
      done: "完了",
      inhale: "吸う",
      hold: "止める",
      exhale: "吐く",
      round: "ラウンド",
      start: "開始",
      running: "実行中...",
      pause: "一時停止",
      resume: "再開",
      reset: "リセット",
      tip_ready: "ヒント：肩の力を抜いて。めまいがしたら中止して自然呼吸に戻してください。",
      tip_running: "表示に合わせて呼吸。つらければ一時停止/リセット。",
      tip_paused: "一時停止中。準備ができたら再開。",
      tip_back: "リズムに戻りました。",
      tip_done: "いい感じ。少し自然呼吸に戻しましょう。",
      back: "← ライブラリへ",
      more1: "ボックス呼吸",
      more2: "4-4-6 呼吸",
      seoTitle: "4-7-8 呼吸とは？",
      seoP1: "4-7-8は、4秒吸う・7秒止める・8秒吐くの呼吸パターンです。就寝前のリラックスやストレス時の落ち着きに使われます。",
      seoList: [
        "<b>睡眠:</b> 夜に4〜8ラウンド",
        "<b>ストレス:</b> いつでも2〜4ラウンド",
        "<b>注意:</b> めまいがしたら中止"
      ],
      phaseLine: (phase, round, max) => `${phase}  •  ${I18N.ja.round} ${round}/${max}`
    },
    es: {
      sub: "Respiración 4-7-8",
      nav_lib: "Biblioteca",
      nav_guide: "Guía",
      nav_about: "Acerca de",
      title: "Temporizador de respiración 4-7-8",
      desc: "Inhala 4 • Mantén 7 • Exhala 8. Un ritmo simple para dormir y calmar el estrés.",
      badge: "Fase",
      langLabel: "Idioma",
      roundsLabel: "Rondas",
      soundLabel: "Sonido",
      soundOff: "Apagado",
      soundSoft: "Bip suave",
      soundStrong: "Bip más fuerte",
      ready: "Listo",
      done: "Hecho",
      inhale: "Inhala",
      hold: "Mantén",
      exhale: "Exhala",
      round: "Ronda",
      start: "Iniciar",
      running: "En curso...",
      pause: "Pausa",
      resume: "Reanudar",
      reset: "Reiniciar",
      tip_ready: "Consejo: relaja los hombros. Si mareas, detente y respira normal.",
      tip_running: "Sigue la guía. Si es incómodo, pausa o reinicia.",
      tip_paused: "Pausado. Reanuda cuando estés listo.",
      tip_back: "De vuelta al ritmo.",
      tip_done: "Bien. Vuelve a respirar normal un momento.",
      back: "← Volver a la biblioteca",
      more1: "Respiración en caja",
      more2: "Respiración 4-4-6",
      seoTitle: "¿Qué es la respiración 4-7-8?",
      seoP1: "4-7-8 es un patrón simple: inhala 4 segundos, mantén 7 y exhala 8. Se usa para relajarse antes de dormir o calmarse durante el estrés.",
      seoList: [
        "<b>Sueño:</b> prueba 4–8 rondas por la noche.",
        "<b>Estrés:</b> 2–4 rondas en cualquier momento.",
        "<b>Seguridad:</b> si mareas, detente."
      ],
      phaseLine: (phase, round, max) => `${phase}  •  ${I18N.es.round} ${round}/${max}`
    }
  };

  // ====== DOM ======
  const phaseLabel = document.getElementById('phaseLabel');
  const phaseDot = document.getElementById('phaseDot');
  const countEl = document.getElementById('count');
  const bar = document.getElementById('bar');

  const roundsInput = document.getElementById('rounds');
  const soundSel = document.getElementById('sound');
  const langSel = document.getElementById('lang');
  const hint = document.getElementById('statusHint');

  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resetBtn = document.getElementById('resetBtn');

  // text nodes
  const t = (id) => document.getElementById(id);

  // ====== State ======
  let timer = null;
  let running = false;
  let paused = false;

  let round = 1;
  let phaseIdx = 0;
  let remaining = pattern[0].seconds;
  let phaseTotal = pattern[0].seconds;

  // ====== Audio (BEEP FIX) ======
  // 문제 원인: 모바일 브라우저는 사용자 제스처 없이 AudioContext 재생 제한
  // 해결: Start 클릭 시 AudioContext를 "unlock"하고 재사용(닫지 않음)
  let audioCtx = null;
  let unlocked = false;

  function ensureAudio(){
    if (!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  async function unlockAudio(){
    try{
      ensureAudio();
      if (audioCtx.state === "suspended") await audioCtx.resume();

      // 아주 짧은 무음/저음 재생으로 unlock
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      g.gain.value = 0.0001;
      o.frequency.value = 220;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + 0.02);

      unlocked = true;
    }catch(e){
      // 그래도 UX는 계속 진행
      unlocked = false;
    }
  }

  function beep(){
    if (soundSel.value === 'off') return;
    if (!audioCtx || !unlocked) return;

    const strong = (soundSel.value === 'strong');
    const freq = strong ? 880 : 740;
    const dur = strong ? 0.11 : 0.08;
    const vol = strong ? 0.06 : 0.035;

    try{
      const now = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();

      o.type = 'sine';
      o.frequency.setValueAtTime(freq, now);

      // 클릭 소리 줄이기: 짧은 attack/decay
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(vol, now + 0.015);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

      o.connect(g);
      g.connect(audioCtx.destination);

      o.start(now);
      o.stop(now + dur + 0.02);
    }catch(e){}
  }

  // ====== Language ======
  function detectLang(){
    const qs = new URLSearchParams(location.search);
    const q = (qs.get("lang") || "").toLowerCase();
    if (I18N[q]) return q;

    const saved = (localStorage.getItem("b24_lang") || "").toLowerCase();
    if (I18N[saved]) return saved;

    const nav = (navigator.language || "en").toLowerCase();
    if (nav.startsWith("ko")) return "ko";
    if (nav.startsWith("ja")) return "ja";
    if (nav.startsWith("es")) return "es";
    return "en";
  }

  function setLang(lang, {pushUrl=true} = {}){
    if (!I18N[lang]) lang = "en";
    localStorage.setItem("b24_lang", lang);
    document.documentElement.lang = lang;

    // top
    t("t_sub").textContent = I18N[lang].sub;
    t("t_nav_lib").textContent = I18N[lang].nav_lib;
    t("t_nav_guide").textContent = I18N[lang].nav_guide;
    t("t_nav_about").textContent = I18N[lang].nav_about;
    t("t_title").textContent = I18N[lang].title;
    t("t_desc").textContent = I18N[lang].desc;
    t("t_badge").textContent = I18N[lang].badge;

    // controls
    t("t_langLabel").textContent = I18N[lang].langLabel;
    t("t_roundsLabel").textContent = I18N[lang].roundsLabel;
    t("t_soundLabel").textContent = I18N[lang].soundLabel;
    t("t_soundOff").textContent = I18N[lang].soundOff;
    t("t_soundSoft").textContent = I18N[lang].soundSoft;
    t("t_soundStrong").textContent = I18N[lang].soundStrong;

    // buttons
    startBtn.textContent = (running && !paused) ? I18N[lang].running : I18N[lang].start;
    pauseBtn.textContent = paused ? I18N[lang].resume : I18N[lang].pause;
    resetBtn.textContent = I18N[lang].reset;

    // more links
    t("t_back").textContent = I18N[lang].back;
    t("t_more1").textContent = I18N[lang].more1;
    t("t_more2").textContent = I18N[lang].more2;

    // seo
    t("t_seoTitle").textContent = I18N[lang].seoTitle;
    t("t_seoP1").textContent = I18N[lang].seoP1;
    const ul = t("t_seoList");
    ul.innerHTML = I18N[lang].seoList.map(x => `<li>${x}</li>`).join("");

    // hint
    if (!running) hint.textContent = I18N[lang].tip_ready;

    // label line refresh
    if (!running){
      phaseLabel.textContent = I18N[lang].ready;
    }else{
      setUI(); // refresh with correct language
    }

    langSel.value = lang;

    if (pushUrl){
      const url = new URL(location.href);
      url.searchParams.set("lang", lang);
      history.replaceState({}, "", url.toString());
    }
  }

  // ====== UI / Logic ======
  function phaseColor(key){
    if (key === "inhale") return getComputedStyle(document.documentElement).getPropertyValue("--inhale").trim();
    if (key === "hold") return getComputedStyle(document.documentElement).getPropertyValue("--hold").trim();
    return getComputedStyle(document.documentElement).getPropertyValue("--exhale").trim();
  }

  function setPhaseVisual(key){
    const c = phaseColor(key);
    phaseDot.style.background = c;
    bar.style.filter = "saturate(1.15)";
    // subtle gradient shift per phase
    if (key === "inhale"){
      bar.style.background = "linear-gradient(90deg, rgba(126,231,194,.92), rgba(157,185,255,.55))";
    } else if (key === "hold"){
      bar.style.background = "linear-gradient(90deg, rgba(255,210,122,.92), rgba(126,231,194,.55))";
    } else {
      bar.style.background = "linear-gradient(90deg, rgba(157,185,255,.92), rgba(255,210,122,.55))";
    }
  }

  function currentLang(){
    return langSel.value && I18N[langSel.value] ? langSel.value : "en";
  }

  function phaseLabelText(lang, phaseKey){
    if (phaseKey === "inhale") return I18N[lang].inhale;
    if (phaseKey === "hold") return I18N[lang].hold;
    return I18N[lang].exhale;
  }

  function setUI(){
    const lang = currentLang();
    const maxRounds = Math.max(1, parseInt(roundsInput.value || '1', 10));
    const phaseKey = pattern[phaseIdx].key;
    const phaseName = phaseLabelText(lang, phaseKey);

    phaseLabel.textContent = I18N[lang].phaseLine(phaseName, round, maxRounds);
    countEl.textContent = String(remaining);

    const pct = phaseTotal ? ((phaseTotal - remaining) / phaseTotal) * 100 : 0;
    bar.style.width = `${Math.max(0, Math.min(100, pct))}%`;

    setPhaseVisual(phaseKey);
  }

  function tick(){
    if (!running || paused) return;

    setUI();

    if (remaining <= 0){
      // phase change + BEEP
      beep();

      phaseIdx++;
      if (phaseIdx >= pattern.length){
        phaseIdx = 0;
        round++;
      }

      const maxRounds = Math.max(1, parseInt(roundsInput.value || '1', 10));
      if (round > maxRounds){
        stop(true);
        return;
      }

      remaining = pattern[phaseIdx].seconds;
      phaseTotal = remaining;
      setUI();
      return;
    }

    remaining -= 1;
  }

  async function start(){
    if (running && !paused) return;

    // unlock audio on user gesture
    await unlockAudio();

    if (!running){
      round = 1;
      phaseIdx = 0;
      remaining = pattern[0].seconds;
      phaseTotal = remaining;
    }

    running = true;
    paused = false;

    const lang = currentLang();
    startBtn.textContent = I18N[lang].running;
    startBtn.disabled = true;
    pauseBtn.disabled = false;
    pauseBtn.textContent = I18N[lang].pause;

    hint.textContent = I18N[lang].tip_running;
    setUI();

    timer = setInterval(tick, 1000);
    tick();
  }

  function pause(){
    if (!running) return;
    paused = !paused;

    const lang = currentLang();
    pauseBtn.textContent = paused ? I18N[lang].resume : I18N[lang].pause;

    startBtn.disabled = !paused;
    startBtn.textContent = paused ? I18N[lang].start : I18N[lang].running;

    hint.textContent = paused ? I18N[lang].tip_paused : I18N[lang].tip_back;
  }

  function stop(completed=false){
    running = false;
    paused = false;
    if (timer) clearInterval(timer);
    timer = null;

    const lang = currentLang();
    startBtn.disabled = false;
    startBtn.textContent = I18N[lang].start;
    pauseBtn.disabled = true;
    pauseBtn.textContent = I18N[lang].pause;

    phaseDot.style.background = getComputedStyle(document.documentElement).getPropertyValue("--muted2").trim();

    phaseLabel.textContent = completed ? I18N[lang].done : I18N[lang].ready;
    countEl.textContent = "—";
    bar.style.width = "0%";
    hint.textContent = completed ? I18N[lang].tip_done : I18N[lang].tip_ready;
  }

  function reset(){
    stop(false);
  }

  // ====== Init ======
  document.getElementById('y').textContent = new Date().getFullYear();

  // set initial language
  const initial = detectLang();
  langSel.value = initial;
  setLang(initial, {pushUrl:true});

  // ready ui
  phaseLabel.textContent = I18N[initial].ready;

  // Events
  startBtn.addEventListener('click', start);
  pauseBtn.addEventListener('click', pause);
  resetBtn.addEventListener('click', reset);

  langSel.addEventListener('change', (e) => setLang(e.target.value, {pushUrl:true}));

  // If user changes rounds during run, keep it safe (no crash)
  roundsInput.addEventListener('change', () => { if (running) setUI(); });

})();
</script>
</body>
</html>