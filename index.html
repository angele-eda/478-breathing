<!doctype html>
<html lang="ko" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Breath • 4-7-8 호흡</title>
  <meta name="description" content="4-7-8 호흡, 박스 호흡, 커스텀 타이머. 스트레스 완화용 고급 UX 호흡 앱 (정적/로컬 실행)." />
  <meta name="theme-color" content="#0b0f17" />
  <meta name="robots" content="index,follow" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#070a10;
      --panel: rgba(255,255,255,.05);
      --panel2: rgba(255,255,255,.075);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.90);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.50);
      --good: rgba(130,255,210,.95);
      --warn: rgba(255,214,117,.95);
      --bad: rgba(255,128,144,.95);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 22px;
      --focus: 0 0 0 3px rgba(130,255,210,.22);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(130,255,210,.08), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(119,168,255,.08), transparent 55%),
        radial-gradient(900px 600px at 55% 95%, rgba(255,214,117,.06), transparent 55%),
        linear-gradient(180deg, #060810, #070a10 40%, #070a10);
      overflow-x:hidden;
    }

    a{ color:inherit; text-decoration:none; }
    button, input, select { font: inherit; }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 18px 28px;
    }

    /* Top bar */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      user-select:none;
    }
    .logo{
      width:38px; height:38px;
      border-radius: 12px;
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.40), transparent 60%),
        linear-gradient(135deg, rgba(130,255,210,.95), rgba(119,168,255,.90));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
      transform: rotate(25deg);
      animation: sheen 5.4s linear infinite;
      opacity:.7;
    }
    @keyframes sheen{
      0%{ transform: translateX(-40%) rotate(25deg); }
      100%{ transform: translateX(40%) rotate(25deg); }
    }
    .brand h1{
      font-size: 16px;
      margin:0;
      letter-spacing: .2px;
      font-weight: 800;
      line-height: 1.1;
    }
    .brand p{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .2px;
    }

    .topActions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .pill small{ color: var(--muted); font-weight:600; }
    .pill strong{ font-weight:800; letter-spacing:.2px; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: var(--stroke2); background: rgba(255,255,255,.06); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn:focus-visible{ outline: none; box-shadow: var(--focus); }
    .btn.primary{
      border-color: rgba(130,255,210,.22);
      background: linear-gradient(135deg, rgba(130,255,210,.18), rgba(119,168,255,.14));
    }
    .btn.danger{
      border-color: rgba(255,128,144,.22);
      background: linear-gradient(135deg, rgba(255,128,144,.16), rgba(255,214,117,.10));
    }
    .btn svg{ width:18px; height:18px; opacity:.92; }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .85fr;
      gap: 14px;
      align-items:stretch;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--r2);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.045);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position:relative;
    }
    .card .hdr{
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
      font-weight: 800;
    }
    .sub{
      margin:6px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height:1.5;
    }

    .content{ padding: 14px 16px 16px; }

    /* Breath stage */
    .stage{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px 12px 10px;
    }
    .orbWrap{
      width: min(420px, 92vw);
      aspect-ratio: 1 / 1;
      display:grid;
      place-items:center;
      position:relative;
    }

    .ring{
      width: 100%;
      height: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(130,255,210,.10), transparent 55%),
        radial-gradient(circle at 40% 70%, rgba(119,168,255,.10), transparent 55%),
        rgba(0,0,0,.10);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        0 26px 70px rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
    }
    .ring:before{
      content:"";
      position:absolute; inset:-60%;
      background: conic-gradient(
        from 90deg,
        rgba(130,255,210,.12),
        rgba(119,168,255,.10),
        rgba(255,214,117,.08),
        rgba(130,255,210,.12)
      );
      filter: blur(10px);
      animation: swirl 10s linear infinite;
      opacity:.85;
    }
    @keyframes swirl{ to{ transform: rotate(360deg); } }

    .orb{
      width: 54%;
      height: 54%;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.08) 45%, transparent 65%),
        radial-gradient(circle at 65% 75%, rgba(130,255,210,.35), transparent 55%),
        radial-gradient(circle at 40% 75%, rgba(119,168,255,.25), transparent 55%),
        rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        0 18px 60px rgba(0,0,0,.40);
      position:absolute;
      display:grid;
      place-items:center;
      transform: scale(1);
      transition: transform 420ms cubic-bezier(.2,.8,.2,1);
      z-index:2;
    }

    .phase{
      text-align:center;
      padding: 10px 12px;
    }
    .phase .label{
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .28em;
      text-transform: uppercase;
      font-weight: 800;
    }
    .phase .big{
      margin-top:8px;
      font-size: 34px;
      letter-spacing: .2px;
      font-weight: 900;
      line-height:1.05;
    }
    .phase .count{
      margin-top: 10px;
      font-variant-numeric: tabular-nums;
      font-size: 16px;
      color: rgba(255,255,255,.80);
      letter-spacing:.2px;
      font-weight: 800;
    }

    /* progress */
    .progressRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 6px;
    }
    .bar{
      flex:1;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      position:relative;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(130,255,210,.75), rgba(119,168,255,.75));
      border-radius: 999px;
      transition: width 160ms linear;
    }
    .meta{
      display:flex;
      gap:10px;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      white-space:nowrap;
    }

    /* Right panel controls */
    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size: 12px;
      font-weight: 800;
      color: rgba(255,255,255,.82);
    }
    .chip:hover{ transform: translateY(-1px); border-color: var(--stroke2); background: rgba(255,255,255,.06); }
    .chip[aria-pressed="true"]{
      border-color: rgba(130,255,210,.22);
      background: linear-gradient(135deg, rgba(130,255,210,.16), rgba(119,168,255,.12));
      color: rgba(255,255,255,.92);
    }
    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 14px;
    }
    .field{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .field label{
      font-size: 12px;
      font-weight: 800;
      color: rgba(255,255,255,.82);
      letter-spacing:.2px;
    }
    .field .hint{
      font-size: 11px;
      color: var(--muted2);
      margin-top:4px;
      font-weight:700;
    }
    .field .left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .num{
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 170px;
      justify-content:flex-end;
    }
    .num input{
      width: 86px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      text-align:right;
      outline:none;
    }
    .num input:focus{ box-shadow: var(--focus); border-color: rgba(130,255,210,.22); }
    .unit{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    .toggle{
      display:flex; align-items:center; gap:10px; justify-content:space-between;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .switch{
      width: 46px; height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      position:relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .switch i{
      width: 22px; height: 22px;
      border-radius: 999px;
      position:absolute;
      top: 2px; left: 2px;
      background: rgba(255,255,255,.82);
      transition: left .16s ease, background .16s ease;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .switch[data-on="true"]{
      border-color: rgba(130,255,210,.22);
      background: rgba(130,255,210,.12);
    }
    .switch[data-on="true"] i{ left: 22px; background: rgba(130,255,210,.95); }

    .footerNote{
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.55;
    }
    .k{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      font-weight: 800;
      margin-top: 10px;
    }
    .srOnly{
      position:absolute !important;
      height:1px; width:1px;
      overflow:hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space:nowrap;
    }

    /* reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand" aria-label="Breath App">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Breath</h1>
          <p>4-7-8 · Box · Custom — 스트레스 내려주는 리듬</p>
        </div>
      </div>

      <div class="topActions">
        <div class="pill" title="현재 상태">
          <small>Phase</small>
          <strong id="pillPhase">Ready</strong>
        </div>
        <button class="btn" id="btnReset" type="button" title="초기화">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 12a9 9 0 1 1-3.2-6.9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M21 3v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Reset
        </button>
        <button class="btn primary" id="btnStart" type="button" title="시작/일시정지">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path id="iconPlay" d="M9 7l10 5-10 5V7z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path id="iconPause" d="M7 6v12M17 6v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="display:none"/>
          </svg>
          <span id="btnStartText">Start</span>
        </button>
      </div>
    </div>

    <div class="grid">
      <!-- Main stage -->
      <section class="card" aria-label="Breathing stage">
        <div class="hdr">
          <div>
            <h2 class="title">가이드</h2>
            <p class="sub">
              화면의 지시에 맞춰 천천히 호흡하세요. 어지러우면 즉시 중단하고 <b>4-4-6</b>처럼 더 짧게 조정해도 됩니다.
            </p>
          </div>
          <div class="k" title="단축키">
            ⌨️ <span>Space 시작/정지 · R 리셋</span>
          </div>
        </div>

        <div class="content">
          <div class="stage">
            <div class="orbWrap">
              <div class="ring" aria-hidden="true"></div>
              <div class="orb" id="orb">
                <div class="phase" role="status" aria-live="polite" aria-atomic="true">
                  <div class="label" id="phaseLabel">READY</div>
                  <div class="big" id="phaseText">준비</div>
                  <div class="count" id="countText">—</div>

                  <div class="progressRow" aria-label="progress">
                    <div class="bar" aria-hidden="true"><i id="barFill"></i></div>
                    <div class="meta">
                      <span id="cycleText">0 / 4 cycles</span>
                      <span>•</span>
                      <span id="totalText">00:00</span>
                    </div>
                  </div>
                </div>
              </div>

              <p class="srOnly" id="srAnnounce"></p>
            </div>
          </div>
        </div>
      </section>

      <!-- Controls -->
      <aside class="card" aria-label="Controls">
        <div class="hdr">
          <div>
            <h2 class="title">프로토콜</h2>
            <p class="sub">4-7-8(기본) / 박스 / 커스텀. 횟수·진동·사운드까지.</p>
          </div>
        </div>

        <div class="content">
          <div class="seg" role="group" aria-label="Select protocol">
            <button class="chip" type="button" data-mode="478" aria-pressed="true">4-7-8</button>
            <button class="chip" type="button" data-mode="box" aria-pressed="false">Box</button>
            <button class="chip" type="button" data-mode="custom" aria-pressed="false">Custom</button>
          </div>

          <div class="row">
            <div class="field">
              <div class="left">
                <label for="inSec">들이마시기</label>
                <div class="hint">코로 천천히</div>
              </div>
              <div class="num">
                <input id="inSec" type="number" min="1" max="20" step="1" value="4" inputmode="numeric" />
                <span class="unit">sec</span>
              </div>
            </div>

            <div class="field">
              <div class="left">
                <label for="holdSec">멈춤(홀드)</label>
                <div class="hint">힘주지 말고 정지</div>
              </div>
              <div class="num">
                <input id="holdSec" type="number" min="0" max="30" step="1" value="7" inputmode="numeric" />
                <span class="unit">sec</span>
              </div>
            </div>

            <div class="field">
              <div class="left">
                <label for="outSec">내쉬기</label>
                <div class="hint">입으로 길게</div>
              </div>
              <div class="num">
                <input id="outSec" type="number" min="1" max="30" step="1" value="8" inputmode="numeric" />
                <span class="unit">sec</span>
              </div>
            </div>

            <div class="field">
              <div class="left">
                <label for="cycles">반복 횟수</label>
                <div class="hint">기본 4회 (필요시 2~6)</div>
              </div>
              <div class="num">
                <input id="cycles" type="number" min="1" max="20" step="1" value="4" inputmode="numeric" />
                <span class="unit">cycles</span>
              </div>
            </div>

            <div class="toggle">
              <div class="left">
                <label>진동(모바일)</label>
                <div class="hint">단계 전환 시 짧게</div>
              </div>
              <div class="switch" id="swVibe" data-on="true" role="switch" aria-checked="true" tabindex="0" title="Toggle vibration">
                <i aria-hidden="true"></i>
              </div>
            </div>

            <div class="toggle">
              <div class="left">
                <label>사운드(비프)</label>
                <div class="hint">단계 전환 시 짧게</div>
              </div>
              <div class="switch" id="swBeep" data-on="false" role="switch" aria-checked="false" tabindex="0" title="Toggle beep">
                <i aria-hidden="true"></i>
              </div>
            </div>

            <div class="footerNote">
              <b>팁:</b> 스트레스가 강하면 <b>4-4-6</b>으로 낮춰서 시작하고,
              안정되면 4-7-8로 올리면 몸이 훨씬 편해져요.
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ====== Breath App (Pro UX, single file) ======
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    const el = {
      pillPhase: $("#pillPhase"),
      btnStart: $("#btnStart"),
      btnStartText: $("#btnStartText"),
      btnReset: $("#btnReset"),
      iconPlay: $("#iconPlay"),
      iconPause: $("#iconPause"),

      phaseLabel: $("#phaseLabel"),
      phaseText: $("#phaseText"),
      countText: $("#countText"),

      barFill: $("#barFill"),
      cycleText: $("#cycleText"),
      totalText: $("#totalText"),
      orb: $("#orb"),
      sr: $("#srAnnounce"),

      inSec: $("#inSec"),
      holdSec: $("#holdSec"),
      outSec: $("#outSec"),
      cycles: $("#cycles"),

      swVibe: $("#swVibe"),
      swBeep: $("#swBeep"),
      chips: $$("[data-mode]")
    };

    const state = {
      running: false,
      mode: "478",
      vibe: true,
      beep: false,

      inSec: 4,
      holdSec: 7,
      outSec: 8,
      cycles: 4,

      phaseIndex: 0,
      phaseLeft: 0,
      cycleNow: 0,

      totalElapsed: 0,
      raf: null,
      timer: null,
      lastTick: 0,

      audioCtx: null
    };

    const phases = [
      { key:"in",   label:"INHALE", text:"들이마시기", scale: 1.12, accent:"good" },
      { key:"hold", label:"HOLD",   text:"멈춤",     scale: 1.00, accent:"warn" },
      { key:"out",  label:"EXHALE", text:"내쉬기",   scale: 0.88, accent:"good" }
    ];

    function pad2(n){ return String(n).padStart(2,"0"); }
    function mmss(sec){
      const m = Math.floor(sec/60);
      const s = Math.floor(sec%60);
      return `${pad2(m)}:${pad2(s)}`;
    }

    function clampInt(v, min, max){
      v = Number.isFinite(+v) ? Math.round(+v) : min;
      return Math.max(min, Math.min(max, v));
    }

    function readInputs(){
      state.inSec   = clampInt(el.inSec.value, 1, 20);
      state.holdSec = clampInt(el.holdSec.value, 0, 30);
      state.outSec  = clampInt(el.outSec.value, 1, 30);
      state.cycles  = clampInt(el.cycles.value, 1, 20);

      // reflect sanitized values back
      el.inSec.value = state.inSec;
      el.holdSec.value = state.holdSec;
      el.outSec.value = state.outSec;
      el.cycles.value = state.cycles;
    }

    function applyMode(mode){
      state.mode = mode;

      // Set defaults per protocol
      if(mode === "478"){
        el.inSec.value = 4;
        el.holdSec.value = 7;
        el.outSec.value = 8;
        // keep cycles
      } else if(mode === "box"){
        // Box breathing: In-Hold-Out-Hold (we'll map to 3-phase by duplicating hold)
        el.inSec.value = 4;
        el.holdSec.value = 4;
        el.outSec.value = 4;
      } else {
        // custom: don't overwrite
      }

      // chip ui
      el.chips.forEach(c=>{
        const on = c.dataset.mode === mode;
        c.setAttribute("aria-pressed", on ? "true" : "false");
      });

      readInputs();
      reset(false);
      renderReady();
    }

    function setRunning(r){
      state.running = r;
      el.btnStartText.textContent = r ? "Pause" : "Start";
      el.iconPlay.style.display = r ? "none" : "";
      el.iconPause.style.display = r ? "" : "none";
    }

    function toggleSwitch(elSw, key){
      const on = elSw.dataset.on === "true";
      const next = !on;
      elSw.dataset.on = next ? "true" : "false";
      elSw.setAttribute("aria-checked", next ? "true" : "false");
      state[key] = next;
      // micro feedback
      if(next) pulseHaptic(10);
    }

    function pulseHaptic(ms=12){
      if(!state.vibe) return;
      if(navigator.vibrate) navigator.vibrate(ms);
    }

    function beep(){
      if(!state.beep) return;
      try{
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if(!AudioContext) return;
        if(!state.audioCtx) state.audioCtx = new AudioContext();
        const ctx = state.audioCtx;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.05;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 0.06);
      }catch(e){ /* ignore */ }
    }

    function announce(msg){
      el.sr.textContent = msg;
    }

    function phaseDuration(idx){
      // For box mode, we simulate: inhale -> hold -> exhale -> hold
      // Our UI is 3-phase; we'll implement 4-phase internally by phaseIndex 0..3
      if(state.mode !== "box"){
        if(idx === 0) return state.inSec;
        if(idx === 1) return state.holdSec;
        return state.outSec;
      } else {
        // box: [in, hold, out, hold]
        if(idx === 0) return state.inSec;
        if(idx === 1) return state.holdSec;
        if(idx === 2) return state.outSec;
        return state.holdSec;
      }
    }

    function phaseMeta(idx){
      if(state.mode !== "box"){
        return phases[idx];
      } else {
        // 4-phase meta, last is HOLD
        if(idx === 0) return phases[0];
        if(idx === 1) return phases[1];
        if(idx === 2) return phases[2];
        return phases[1];
      }
    }

    function phaseCount(){
      return state.mode === "box" ? 4 : 3;
    }

    function renderReady(){
      el.pillPhase.textContent = "Ready";
      el.phaseLabel.textContent = "READY";
      el.phaseText.textContent = "준비";
      el.countText.textContent = "Start를 누르세요";
      el.barFill.style.width = "0%";
      el.cycleText.textContent = `0 / ${state.cycles} cycles`;
      el.totalText.textContent = "00:00";
      el.orb.style.transform = "scale(1)";
      announce("준비. 시작 버튼을 누르세요.");
    }

    function renderPhase(){
      const meta = phaseMeta(state.phaseIndex);
      const dur = phaseDuration(state.phaseIndex);
      const left = state.phaseLeft;

      el.pillPhase.textContent = meta.text;
      el.phaseLabel.textContent = meta.label;
      el.phaseText.textContent = meta.text;
      el.countText.textContent = `${left}s`;

      // orb scale
      el.orb.style.transform = `scale(${meta.scale})`;

      // progress within current phase
      const done = Math.max(0, dur - left);
      const pct = dur === 0 ? 0 : Math.min(100, Math.max(0, (done / dur) * 100));
      el.barFill.style.width = pct.toFixed(1) + "%";

      el.cycleText.textContent = `${state.cycleNow} / ${state.cycles} cycles`;
      el.totalText.textContent = mmss(state.totalElapsed);

      announce(`${meta.text} ${left}초`);
    }

    function nextPhase(){
      // Transition
      pulseHaptic(12);
      beep();

      state.phaseIndex += 1;
      if(state.phaseIndex >= phaseCount()){
        state.phaseIndex = 0;
        state.cycleNow += 1;
      }

      if(state.cycleNow > state.cycles){
        finish();
        return;
      }

      const dur = phaseDuration(state.phaseIndex);
      state.phaseLeft = dur;
      renderPhase();
    }

    function finish(){
      stopTimer();
      setRunning(false);

      el.pillPhase.textContent = "Done";
      el.phaseLabel.textContent = "DONE";
      el.phaseText.textContent = "완료";
      el.countText.textContent = "좋았어. 천천히 눈 감고 10초.";
      el.barFill.style.width = "100%";
      el.orb.style.transform = "scale(1)";
      announce("호흡 완료.");
      pulseHaptic(24);
    }

    function start(){
      readInputs();
      if(state.cycles < 1) state.cycles = 1;
      reset(false);

      state.running = true;
      setRunning(true);

      state.cycleNow = 1;
      state.phaseIndex = 0;
      state.phaseLeft = phaseDuration(0);
      state.totalElapsed = 0;

      renderPhase();
      startTimer();
    }

    function pause(){
      stopTimer();
      setRunning(false);
      state.running = false;
      el.pillPhase.textContent = "Paused";
      announce("일시정지.");
    }

    function resume(){
      if(state.cycleNow === 0){
        start();
        return;
      }
      setRunning(true);
      state.running = true;
      startTimer();
      announce("재개.");
    }

    function reset(alsoStop=true){
      if(alsoStop){
        stopTimer();
        setRunning(false);
        state.running = false;
      }
      state.phaseIndex = 0;
      state.phaseLeft = 0;
      state.cycleNow = 0;
      state.totalElapsed = 0;
      el.barFill.style.width = "0%";
      el.orb.style.transform = "scale(1)";
    }

    function tick(){
      const now = performance.now();
      if(!state.lastTick) state.lastTick = now;
      const dt = (now - state.lastTick) / 1000;
      state.lastTick = now;

      // We tick in whole seconds for clarity, but keep elapsed smooth
      state._acc = (state._acc || 0) + dt;
      if(state._acc >= 1){
        const steps = Math.floor(state._acc);
        state._acc -= steps;

        for(let i=0;i<steps;i++){
          state.totalElapsed += 1;
          state.phaseLeft -= 1;

          if(state.phaseLeft <= 0){
            nextPhase();
            // nextPhase renders; but if finished, break
            if(!state.running) break;
          } else {
            renderPhase();
          }
        }
      } else {
        // update time display even between seconds
        el.totalText.textContent = mmss(state.totalElapsed);
      }

      if(state.running) state.raf = requestAnimationFrame(tick);
    }

    function startTimer(){
      stopTimer();
      state.lastTick = 0;
      state._acc = 0;
      state.raf = requestAnimationFrame(tick);
    }
    function stopTimer(){
      if(state.raf) cancelAnimationFrame(state.raf);
      state.raf = null;
      state.lastTick = 0;
      state._acc = 0;
    }

    // ====== events ======
    el.btnStart.addEventListener("click", ()=>{
      if(!state.running){
        if(state.cycleNow === 0) start();
        else resume();
      } else {
        pause();
      }
    });

    el.btnReset.addEventListener("click", ()=>{
      readInputs();
      reset(true);
      renderReady();
      pulseHaptic(12);
    });

    el.chips.forEach(ch=>{
      ch.addEventListener("click", ()=>{
        applyMode(ch.dataset.mode);
        pulseHaptic(10);
      });
    });

    [el.inSec, el.holdSec, el.outSec, el.cycles].forEach(inp=>{
      inp.addEventListener("change", ()=>{
        readInputs();
        // If running, do not hard reset; just apply next cycle
        if(state.cycleNow === 0){
          renderReady();
        }
      });
    });

    el.swVibe.addEventListener("click", ()=>toggleSwitch(el.swVibe, "vibe"));
    el.swBeep.addEventListener("click", ()=>toggleSwitch(el.swBeep, "beep"));
    el.swVibe.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleSwitch(el.swVibe,"vibe"); }});
    el.swBeep.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleSwitch(el.swBeep,"beep"); }});

    // keyboard shortcuts
    window.addEventListener("keydown", (e)=>{
      if(e.target && ["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)) return;
      if(e.key === " "){
        e.preventDefault();
        el.btnStart.click();
      } else if(e.key.toLowerCase() === "r"){
        e.preventDefault();
        el.btnReset.click();
      }
    });

    // init
    readInputs();
    applyMode("478");
    renderReady();
  </script>
</body>
</html>